BCL — Manual de Referencia Específico: CLOCK (v1.0)
----------------------------------------------------
Autor: Rafa
Fecha: Octubre 2025

Objetivo
--------
Este documento define el comando CLOCK de BCL, inspirado en la implementación de Tcl (8.x),
adaptándolo al estilo BCL (case-insensitive, todo STRING, sin switches con '-').
La semántica, unidades de tiempo y comportamiento (zona horaria, DST, fin de mes, etc.)
siguen de forma fiel a Tcl en lo posible.

Resumen de subcomandos
----------------------
CLOCK SECONDS
CLOCK MILLISECONDS
CLOCK MICROSECONDS          ;# si la plataforma lo soporta
CLOCK FORMAT tiempo [FORMAT fmt] [TIMEZONE tz] [LOCALE loc] [GMT]
CLOCK SCAN texto [FORMAT fmt] [TIMEZONE tz] [LOCALE loc] [BASE t0] [GMT]
CLOCK ADD tiempo cantidad unidad [cantidad unidad ...] [TIMEZONE tz] [GMT]

Notas generales
---------------
- 'tiempo' es un instante expresado como segundos desde epoch Unix (1970-01-01T00:00:00Z).
- 'GMT' fuerza la interpretación/salida en UTC (equivalente al uso de UTC en Tcl).
- 'TIMEZONE tz' usa identificadores IANA (p. ej. Europe/Madrid, UTC, America/New_York).
- 'LOCALE loc' controla nombres de meses/días (p. ej., es_ES, en_US) si la plataforma lo soporta.
- Todas las entradas y salidas son STRING; los números se convierten automáticamente.
- Cuando hay conflicto entre TIMEZONE y GMT, prevalece GMT (UTC).
- El comportamiento de fin de mes sigue Tcl: al sumar meses/años, si el día no existe en el
  nuevo mes, se ajusta al último día válido (clipping).

----------------------------------------------------
1) CLOCK SECONDS
----------------------------------------------------
Propósito
  Devuelve el tiempo actual en segundos desde epoch (entero).

Sintaxis
  CLOCK SECONDS

Ejemplo
  SET t [CLOCK SECONDS]
  PUTS "segundos=$t"

----------------------------------------------------
2) CLOCK MILLISECONDS
----------------------------------------------------
Propósito
  Devuelve el tiempo actual en milisegundos desde epoch (entero).

Sintaxis
  CLOCK MILLISECONDS

Ejemplo
  SET ms [CLOCK MILLISECONDS]
  PUTS "ms=$ms"

----------------------------------------------------
3) CLOCK MICROSECONDS (opcional)
----------------------------------------------------
Propósito
  Devuelve el tiempo actual en microsegundos desde epoch (entero), si la plataforma lo admite.

Sintaxis
  CLOCK MICROSECONDS

Ejemplo
  SET us [CLOCK MICROSECONDS]
  PUTS "us=$us"

----------------------------------------------------
4) CLOCK FORMAT
----------------------------------------------------
Propósito
  Formatea un instante 'tiempo' (segundos epoch) a una cadena legible.

Sintaxis
  CLOCK FORMAT tiempo [FORMAT fmt] [TIMEZONE tz] [LOCALE loc] [GMT]

Parámetros
  tiempo       Segundos desde epoch (entero o string convertible).
  FORMAT fmt   Patrón de formato estilo Tcl/strftime.
  TIMEZONE tz  Zona horaria (IANA). Si se omite, usa localtime.
  LOCALE loc   Locale para nombres de meses/días.
  GMT          Fuerza UTC.

Formato (fmt) — especificadores comunes (compatibles con Tcl)
  %a  nombre abreviado del día (locale)       %A  nombre completo del día
  %b  nombre abreviado del mes                %B  nombre completo del mes
  %d  día del mes (01..31)                    %e  día del mes (1..31, con espacio inicial)
  %m  mes (01..12)                            %y  año (00..99)
  %Y  año (4 dígitos)                         %H  hora (00..23)
  %I  hora (01..12)                           %p  AM/PM (locale)
  %M  minutos (00..59)                        %S  segundos (00..60, con segundo bisiesto)
  %z  offset numérico de zona (+hhmm)         %Z  abreviatura zona (p. ej., CET)
  %j  día del año (001..366)                  %w  día de semana (0=Dom..6=Sab)
  %U  semana del año (Dom inicio)             %W  semana del año (Lun inicio)
  %s  segundos epoch                           %%  literal '%'

Valores por defecto
  Si no se indica FORMAT, se usa un formato por defecto similar a Tcl:
  "%a %b %d %H:%M:%S %Z %Y"

Ejemplos
  SET now [CLOCK SECONDS]
  PUTS [CLOCK FORMAT $now]
  PUTS [CLOCK FORMAT $now FORMAT "%Y-%m-%d %H:%M:%S"]
  PUTS [CLOCK FORMAT $now FORMAT "%Y-%m-%d %H:%M:%S %z" GMT]
  PUTS [CLOCK FORMAT $now FORMAT "%A, %d de %B de %Y" TIMEZONE "Europe/Madrid" LOCALE "es_ES"]

----------------------------------------------------
5) CLOCK SCAN
----------------------------------------------------
Propósito
  Convierte una cadena de fecha/hora en un instante (segundos epoch).

Sintaxis
  CLOCK SCAN texto [FORMAT fmt] [TIMEZONE tz] [LOCALE loc] [BASE t0] [GMT]

Parámetros
  texto        Cadena de fecha/hora a interpretar.
  FORMAT fmt   Patrón explícito de parseo (estilo Tcl/strftime). Recomendado para precisión.
  TIMEZONE tz  Zona a usar al interpretar (si no se indica GMT).
  LOCALE loc   Locale para nombres de meses/días.
  BASE t0      Instante base para interpretaciones relativas (p. ej., "tomorrow", "+2 days").
  GMT          Fuerza UTC en la interpretación.

Notas
  - Cuando se proporciona FORMAT, se intenta un parseo exacto.
  - Si no se proporciona FORMAT, se permiten algunas formas naturales comunes (estilo Tcl),
    p. ej., "now", "yesterday", "tomorrow", "+2 days", "-3 hours", "2025-10-19 12:34:00", etc. (*según build*).
  - 'BASE' define el punto de referencia para interpretaciones relativas (por defecto, NOW).

Ejemplos
  SET t1 [CLOCK SCAN "2025-10-19 12:34:00" FORMAT "%Y-%m-%d %H:%M:%S" TIMEZONE "Europe/Madrid"]
  SET t2 [CLOCK SCAN "tomorrow" BASE [CLOCK SECONDS] GMT]
  SET t3 [CLOCK SCAN "19/10/2025 08:00" FORMAT "%d/%m/%Y %H:%M" LOCALE "es_ES"]

----------------------------------------------------
6) CLOCK ADD
----------------------------------------------------
Propósito
  Suma intervalos a un instante (segundos epoch) y devuelve el nuevo instante.
  Compatible con unidades y reglas de Tcl (DST, fin de mes).

Sintaxis
  CLOCK ADD tiempo cantidad unidad [cantidad unidad ...] [TIMEZONE tz] [GMT]

Unidades soportadas
  years, months, weeks, days, hours, minutes, seconds
  (singular o plural, p. ej., year/month/week/day/hour/minute/second)

Reglas (siguiendo Tcl)
  - Al sumar meses/años, si el día no existe en el mes resultante, se usa el último día válido (clipping).
    Ej.: sumar 1 mes a 2024-01-31 → 2024-02-29 (año bisiesto); a 2025-01-31 → 2025-02-28.
  - Cambios de DST: CLOCK ADD intenta preservar la “hora local aparente”; si el instante cae en una hora
    inexistente por cambio de DST, se ajusta según reglas del sistema (Tcl: local civil time).
  - Se pueden encadenar varias parejas cantidad/unidad en una sola llamada.

Ejemplos
  SET base [CLOCK SCAN "2025-01-31 12:00:00" FORMAT "%Y-%m-%d %H:%M:%S" TIMEZONE "Europe/Madrid"]
  SET tA [CLOCK ADD $base 1 month TIMEZONE "Europe/Madrid"]    ;# clipping de fin de mes
  SET tB [CLOCK ADD $base 1 year 2 months 3 days GMT]
  SET tC [CLOCK ADD [CLOCK SECONDS] 90 minutes]

  PUTS [CLOCK FORMAT $tA FORMAT "%Y-%m-%d %H:%M:%S" TIMEZONE "Europe/Madrid"]
  PUTS [CLOCK FORMAT $tB FORMAT "%Y-%m-%d %H:%M:%S" GMT]
  PUTS [CLOCK FORMAT $tC FORMAT "%H:%M"]

----------------------------------------------------
7) Consideraciones de zona horaria y DST
----------------------------------------------------
- TIMEZONE: usa la base de datos IANA. Si no se especifica, se asume zona local del sistema.
- GMT: fuerza UTC, ignorando la zona local y TIMEZONE.
- DST (horario de verano): los cálculos con CLOCK ADD y las conversiones con FORMAT/SCAN
  siguen las reglas del sistema, igual que Tcl. Si el instante es ambiguo o inexistente
  (cambio de hora), el resultado se ajusta según las reglas locales.

----------------------------------------------------
8) Errores comunes y recomendaciones
----------------------------------------------------
- Formatos inconsistentes: especificar FORMAT en SCAN para evitar ambigüedades (dd/mm vs mm/dd).
- Unidades mal escritas: usar los nombres canónicos (year(s), month(s), week(s), day(s), hour(s),
  minute(s), second(s)).
- Zonas horarias: preferir TIMEZONE explícito cuando el script debe ser portable entre sistemas.
- Usar GMT cuando se requiera independencia de la zona local.

----------------------------------------------------
9) Ejemplo integrado
----------------------------------------------------
# Obtener tiempos actuales
SET s  [CLOCK SECONDS]
SET ms [CLOCK MILLISECONDS]
PUTS "s=$s ms=$ms"

# Formatear en varias zonas y formatos
PUTS [CLOCK FORMAT $s FORMAT "%Y-%m-%d %H:%M:%S %Z" TIMEZONE "Europe/Madrid"]
PUTS [CLOCK FORMAT $s FORMAT "%Y-%m-%d %H:%M:%S %z" GMT]

# Parsear cadenas y sumar intervalos
SET vuelo  [CLOCK SCAN "2025-03-30 01:30:00" FORMAT "%Y-%m-%d %H:%M:%S" TIMEZONE "Europe/Madrid"]
SET llegada [CLOCK ADD $vuelo 2 hours TIMEZONE "Europe/Madrid"]
PUTS "Salida : " [CLOCK FORMAT $vuelo FORMAT "%F %T %Z" TIMEZONE "Europe/Madrid"]
PUTS "Llegada: " [CLOCK FORMAT $llegada FORMAT "%F %T %Z" TIMEZONE "Europe/Madrid"]

# Base + relativo
SET base [CLOCK SCAN "2025-10-19" FORMAT "%Y-%m-%d" GMT]
SET t    [CLOCK SCAN "tomorrow 08:00" BASE $base GMT]
PUTS [CLOCK FORMAT $t FORMAT "%c" GMT]

----------------------------------------------------
FIN DEL DOCUMENTO
----------------------------------------------------
