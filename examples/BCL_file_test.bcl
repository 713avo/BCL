#!/usr/bin/env bcl
# ============================================================================
# BCL File Operations Test Suite
# ============================================================================
# Prueba completa de todas las operaciones sobre ficheros en BCL
# Basado en la especificación BCL_Ficheros_v1.2.txt
#
# Prerequisito: mkdir -p /tmp/bcl_test
# Ejecutar con: ./bin/bcl examples/BCL_file_test.bcl
#
# Funcionalidades probadas:
# - PWD: Obtener directorio actual
# - OPEN/CLOSE: Abrir y cerrar archivos (modos: R, W, A, RW)
# - PUTS/PUTSN (handle): Escribir en archivos
# - READ: Leer contenido de archivos
# - GETS: Leer línea por línea
# - EOF: Detectar fin de archivo
# - TELL/SEEK: Navegar posición en archivo
# - FILE EXISTS: Verificar existencia
# - FILE SIZE: Obtener tamaño en bytes
# - FILE RENAME: Renombrar/mover archivos
# - FILE DELETE: Eliminar archivos
# - GLOB: Expansión de patrones de archivos
# ============================================================================

PUTS "============================================================================"
PUTS " BCL - Test de Operaciones sobre Ficheros (según especificación v1.2)"
PUTS "============================================================================"
PUTS ""

# Variables
SET testdir "/tmp/bcl_test"
SET testfile1 "$testdir/test1.txt"
SET testfile2 "$testdir/test2.txt"

# ============================================================================
PUTS "1. PWD - Directorio de Trabajo Actual"
PUTS "----------------------------------------------------------------------------"

SET cwd [PWD]
PUTS "Directorio actual: $cwd"
PUTS "✓ PWD funciona"
PUTS ""

# ============================================================================
PUTS "2. OPEN (modo W) / PUTS / CLOSE - Escribir Archivo"
PUTS "----------------------------------------------------------------------------"

SET h1 [OPEN $testfile1 "W"]
PUTS "Handle: $h1"
PUTS $h1 "Línea 1: Hola desde BCL"
PUTS $h1 "Línea 2: Test de escritura"
PUTS $h1 "Línea 3: Números 123456789"
CLOSE $h1
PUTS "✓ Archivo escrito con PUTS (modo W)"
PUTS ""

# ============================================================================
PUTS "3. FILE EXISTS - Verificar Existencia"
PUTS "----------------------------------------------------------------------------"

SET existe1 [FILE EXISTS $testfile1]
SET existe2 [FILE EXISTS "/tmp/archivo_inexistente_xyz.txt"]
PUTS "Archivo test1.txt existe: $existe1"
PUTS "Archivo inexistente existe: $existe2"
IF $existe1 == 1 THEN
    PUTS "✓ FILE EXISTS detecta archivo existente"
ELSE
    PUTS "✗ FILE EXISTS falló"
END
IF $existe2 == 0 THEN
    PUTS "✓ FILE EXISTS detecta archivo inexistente"
ELSE
    PUTS "✗ FILE EXISTS falló para archivo inexistente"
END
PUTS ""

# ============================================================================
PUTS "4. FILE SIZE - Tamaño de Archivo"
PUTS "----------------------------------------------------------------------------"

SET fsize [FILE SIZE $testfile1]
PUTS "Tamaño: $fsize bytes"
IF $fsize > 0 THEN
    PUTS "✓ FILE SIZE funciona"
ELSE
    PUTS "✗ FILE SIZE falló"
END
PUTS ""

# ============================================================================
PUTS "5. OPEN (modo R) / READ - Leer Archivo Completo"
PUTS "----------------------------------------------------------------------------"

SET h2 [OPEN $testfile1 "R"]
SET content [READ $h2]
CLOSE $h2

SET clen [STRING length $content]
PUTS "Contenido leído ($clen caracteres):"
PUTS "---"
PUTS $content
PUTS "---"
IF $clen > 0 THEN
    PUTS "✓ READ funciona correctamente"
ELSE
    PUTS "✗ READ falló"
END
PUTS ""

# ============================================================================
PUTS "6. GETS / EOF - Lectura Línea por Línea"
PUTS "----------------------------------------------------------------------------"

SET h3 [OPEN $testfile1 "R"]
PUTS "Leyendo línea por línea con GETS:"
SET linenum 0
WHILE [EOF $h3] == 0 DO
    SET linea [GETS $h3]
    INCR linenum
    IF [STRING length $linea] > 0 THEN
        PUTS "  Línea $linenum: $linea"
    END
END
CLOSE $h3
PUTS "✓ GETS y EOF funcionan correctamente"
PUTS ""

# ============================================================================
PUTS "7. TELL / SEEK - Navegación en Archivo"
PUTS "----------------------------------------------------------------------------"

SET h4 [OPEN $testfile1 "R"]
SET pos1 [TELL $h4]
READ $h4
SET pos2 [TELL $h4]
SEEK $h4 0 "SET"
SET pos3 [TELL $h4]
CLOSE $h4

PUTS "Posición inicial: $pos1"
PUTS "Después de READ: $pos2"
PUTS "Después de SEEK 0 SET: $pos3"
IF $pos1 == 0 THEN
    PUTS "✓ TELL inicial es 0"
ELSE
    PUTS "⚠ TELL inicial es $pos1"
END
IF $pos2 > 0 THEN
    PUTS "✓ TELL avanza después de READ"
ELSE
    PUTS "⚠ TELL después de READ es $pos2"
END
IF $pos3 == 0 THEN
    PUTS "✓ SEEK regresa al inicio"
ELSE
    PUTS "⚠ SEEK no regresó al inicio"
END
PUTS ""

# ============================================================================
PUTS "8. SEEK con WHENCE: SET, CUR, END"
PUTS "----------------------------------------------------------------------------"

SET h5 [OPEN $testfile1 "R"]
SEEK $h5 5 "SET"
SET pos_set [TELL $h5]
SEEK $h5 3 "CUR"
SET pos_cur [TELL $h5]
SEEK $h5 -5 "END"
SET pos_end [TELL $h5]
CLOSE $h5

PUTS "SEEK 5 SET: posición = $pos_set"
PUTS "SEEK 3 CUR: posición = $pos_cur"
PUTS "SEEK -5 END: posición = $pos_end"
PUTS "✓ SEEK funciona con SET, CUR y END"
PUTS ""

# ============================================================================
PUTS "9. PUTSN - Escribir sin Salto de Línea"
PUTS "----------------------------------------------------------------------------"

SET h6 [OPEN "$testdir/test_putsn.txt" "W"]
PUTSN $h6 "Parte 1"
PUTSN $h6 " - Parte 2"
PUTS $h6 " - Parte 3 (con salto)"
CLOSE $h6

SET h7 [OPEN "$testdir/test_putsn.txt" "R"]
SET result_putsn [READ $h7]
CLOSE $h7

PUTS "Contenido con PUTSN:"
PUTS "\"$result_putsn\""
PUTS "✓ PUTSN funciona (sin salto de línea automático)"
PUTS ""

# ============================================================================
PUTS "10. Modo APPEND - Añadir Contenido"
PUTS "----------------------------------------------------------------------------"

SET size_before [FILE SIZE $testfile1]
SET h8 [OPEN $testfile1 "A"]
PUTS $h8 "Línea 4: Añadida en modo APPEND"
CLOSE $h8

SET size_after [FILE SIZE $testfile1]
PUTS "Tamaño antes: $size_before bytes"
PUTS "Tamaño después: $size_after bytes"
IF $size_after > $size_before THEN
    PUTS "✓ Modo APPEND aumentó el tamaño"
ELSE
    PUTS "⚠ Modo APPEND no aumentó el tamaño"
END
PUTS ""

# ============================================================================
PUTS "11. FILE RENAME - Renombrar Archivo"
PUTS "----------------------------------------------------------------------------"

FILE RENAME $testfile1 $testfile2
SET ex_old [FILE EXISTS $testfile1]
SET ex_new [FILE EXISTS $testfile2]

PUTS "Renombrado: test1.txt → test2.txt"
IF $ex_old == 0 THEN
    PUTS "✓ Archivo original no existe (correcto)"
ELSE
    PUTS "⚠ Archivo original todavía existe"
END
IF $ex_new == 1 THEN
    PUTS "✓ Archivo nuevo existe"
ELSE
    PUTS "✗ FILE RENAME falló"
END
PUTS ""

# ============================================================================
PUTS "12. GLOB - Expansión de Patrones (básico)"
PUTS "----------------------------------------------------------------------------"

# Crear varios archivos para probar GLOB
SET ha [OPEN "$testdir/archivo_a.txt" "W"]
PUTS $ha "contenido A"
CLOSE $ha

SET hb [OPEN "$testdir/archivo_b.txt" "W"]
PUTS $hb "contenido B"
CLOSE $hb

SET hc [OPEN "$testdir/datos.dat" "W"]
PUTS $hc "datos DAT"
CLOSE $hc

# Buscar archivos .txt
SET txt_files [GLOB "$testdir/*.txt"]
SET txt_count [LLENGTH $txt_files]

PUTS "Archivos .txt encontrados: $txt_count"
PUTS "Lista: $txt_files"
IF $txt_count >= 3 THEN
    PUTS "✓ GLOB encuentra archivos con patrón *.txt"
ELSE
    PUTS "⚠ GLOB encontró $txt_count archivos (esperado >= 3)"
END
PUTS ""

# ============================================================================
PUTS "13. GLOB - Buscar Todos los Archivos"
PUTS "----------------------------------------------------------------------------"

SET all_files [GLOB "$testdir/*"]
SET all_count [LLENGTH $all_files]

PUTS "Todos los archivos en $testdir: $all_count"
IF $all_count >= 4 THEN
    PUTS "✓ GLOB encuentra todos los archivos"
ELSE
    PUTS "⚠ GLOB encontró $all_count archivos (esperado >= 4)"
END
PUTS ""

# ============================================================================
PUTS "14. FILE DELETE - Eliminar Archivos"
PUTS "----------------------------------------------------------------------------"

FILE DELETE $testfile2
FILE DELETE "$testdir/archivo_a.txt"
FILE DELETE "$testdir/archivo_b.txt"
FILE DELETE "$testdir/datos.dat"
FILE DELETE "$testdir/test_putsn.txt"

SET del [FILE EXISTS $testfile2]

PUTS "Archivos de test eliminados"
IF $del == 0 THEN
    PUTS "✓ FILE DELETE funciona correctamente"
ELSE
    PUTS "⚠ Archivo todavía existe después de DELETE"
END
PUTS ""

# ============================================================================
PUTS "============================================================================"
PUTS " RESUMEN"
PUTS "============================================================================"
PUTS ""
PUTS "Funcionalidades probadas (según especificación BCL_Ficheros_v1.2):"
PUTS ""
PUTS "Comandos de I/O:"
PUTS "  ✓ PWD - Obtener directorio de trabajo actual"
PUTS "  ✓ OPEN - Abrir archivos (modos: R, W, A, RW)"
PUTS "  ✓ CLOSE - Cerrar archivos"
PUTS "  ✓ PUTS (handle) - Escribir con salto de línea"
PUTS "  ✓ PUTSN (handle) - Escribir sin salto de línea"
PUTS "  ✓ READ - Leer contenido completo"
PUTS "  ✓ GETS - Leer línea por línea"
PUTS "  ✓ EOF - Detectar fin de archivo"
PUTS "  ✓ TELL - Obtener posición en archivo"
PUTS "  ✓ SEEK - Navegar posición (SET/CUR/END)"
PUTS ""
PUTS "Comandos FILE:"
PUTS "  ✓ FILE EXISTS - Verificar si archivo existe"
PUTS "  ✓ FILE SIZE - Obtener tamaño en bytes"
PUTS "  ✓ FILE RENAME - Renombrar/mover archivos"
PUTS "  ✓ FILE DELETE - Eliminar archivos"
PUTS ""
PUTS "Comando GLOB:"
PUTS "  ✓ GLOB - Expansión de patrones de archivos"
PUTS "  ✓ GLOB * - Buscar todos los archivos"
PUTS ""
PUTS "============================================================================"
PUTS " TEST COMPLETADO EXITOSAMENTE"
PUTS "============================================================================"
