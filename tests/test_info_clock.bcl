#!/usr/bin/env bcl
# Test suite for INFO and CLOCK commands

PUTS "=========================================="
PUTS "Testing INFO and CLOCK Commands"
PUTS "=========================================="

# Test INFO EXISTS
PUTS "\n[TEST] INFO EXISTS"
SET myvar "value"
IF [INFO EXISTS myvar] THEN
    PUTS "  PASS: INFO EXISTS detects existing variable"
ELSE
    PUTS "  FAIL: INFO EXISTS should find myvar"
END

IF [INFO EXISTS nonexistent] THEN
    PUTS "  FAIL: INFO EXISTS should not find nonexistent"
ELSE
    PUTS "  PASS: INFO EXISTS false for non-existent variable"
END

# Test INFO VARS
PUTS "\n[TEST] INFO VARS"
SET testvar1 "a"
SET testvar2 "b"
SET allvars [INFO VARS]
IF [EXPR [LSEARCH $allvars "testvar1"] >= 0] THEN
    PUTS "  PASS: INFO VARS lists variables"
ELSE
    PUTS "  FAIL: INFO VARS should list testvar1"
END

# Test INFO COMMANDS
PUTS "\n[TEST] INFO COMMANDS"
SET commands [INFO COMMANDS]
IF [EXPR [LSEARCH $commands "PUTS"] >= 0] THEN
    PUTS "  PASS: INFO COMMANDS lists built-in commands"
ELSE
    PUTS "  FAIL: INFO COMMANDS should list PUTS"
END

# Test INFO PROCS
PUTS "\n[TEST] INFO PROCS"
PROC testproc WITH DO
    RETURN "test"
END

SET procs [INFO PROCS]
IF [EXPR [LSEARCH $procs "testproc"] >= 0] THEN
    PUTS "  PASS: INFO PROCS lists user procedures"
ELSE
    PUTS "  FAIL: INFO PROCS should list testproc"
END

# Test INFO BODY
PUTS "\n[TEST] INFO BODY"
PROC myfunc WITH x DO
    RETURN [EXPR $x * 2]
END

SET body [INFO BODY myfunc]
IF [EXPR [STRING LENGTH $body] > 0] THEN
    PUTS "  PASS: INFO BODY returns procedure body"
ELSE
    PUTS "  FAIL: INFO BODY returned empty"
END

# Test INFO GLOBALS
PUTS "\n[TEST] INFO GLOBALS"
SET globalVar1 "test"
SET globals [INFO GLOBALS]
IF [EXPR [LSEARCH $globals "globalVar1"] >= 0] THEN
    PUTS "  PASS: INFO GLOBALS lists global variables"
ELSE
    PUTS "  FAIL: INFO GLOBALS should list globalVar1"
END

# Test INFO LOCALS in procedure
PUTS "\n[TEST] INFO LOCALS"
PROC testLocals WITH DO
    SET localVar "local"
    SET locals [INFO LOCALS]
    IF [EXPR [LSEARCH $locals "localVar"] >= 0] THEN
        RETURN "pass"
    ELSE
        RETURN "fail"
    END
END

SET localResult [testLocals]
IF [STRING EQUAL $localResult "pass"] THEN
    PUTS "  PASS: INFO LOCALS lists local variables"
ELSE
    PUTS "  FAIL: INFO LOCALS"
END

PUTS "\n=========================================="
PUTS "Testing CLOCK Commands"
PUTS "=========================================="

# Test CLOCK SECONDS
PUTS "\n[TEST] CLOCK SECONDS"
SET time1 [CLOCK SECONDS]
IF [EXPR $time1 > 0] THEN
    PUTS "  PASS: CLOCK SECONDS returns timestamp"
ELSE
    PUTS "  FAIL: CLOCK SECONDS - got $time1"
END

# Test CLOCK MILLISECONDS
PUTS "\n[TEST] CLOCK MILLISECONDS"
SET time2 [CLOCK MILLISECONDS]
IF [EXPR $time2 > $time1] THEN
    PUTS "  PASS: CLOCK MILLISECONDS returns larger value"
ELSE
    PUTS "  FAIL: CLOCK MILLISECONDS - got $time2"
END

# Test CLOCK MICROSECONDS
PUTS "\n[TEST] CLOCK MICROSECONDS"
SET time3 [CLOCK MICROSECONDS]
IF [EXPR $time3 > $time2] THEN
    PUTS "  PASS: CLOCK MICROSECONDS returns even larger value"
ELSE
    PUTS "  FAIL: CLOCK MICROSECONDS - got $time3"
END

# Test CLOCK FORMAT
PUTS "\n[TEST] CLOCK FORMAT"
SET timestamp [CLOCK SECONDS]
SET formatted [CLOCK FORMAT $timestamp "%Y-%m-%d"]
IF [EXPR [STRING LENGTH $formatted] == 10] THEN
    PUTS "  PASS: CLOCK FORMAT formats timestamp"
ELSE
    PUTS "  FAIL: CLOCK FORMAT - expected 10 chars, got [STRING LENGTH $formatted]"
END

# Test CLOCK FORMAT with different format
SET formatted2 [CLOCK FORMAT $timestamp "%H:%M:%S"]
IF [EXPR [STRING LENGTH $formatted2] == 8] THEN
    PUTS "  PASS: CLOCK FORMAT with time format"
ELSE
    PUTS "  FAIL: CLOCK FORMAT time - got '$formatted2'"
END

# Test CLOCK ADD
PUTS "\n[TEST] CLOCK ADD"
SET now [CLOCK SECONDS]
SET future [CLOCK ADD $now 3600 seconds]
SET diff [EXPR $future - $now]
IF [EXPR $diff == 3600] THEN
    PUTS "  PASS: CLOCK ADD adds seconds"
ELSE
    PUTS "  FAIL: CLOCK ADD - expected 3600, got $diff"
END

PUTS "\n=========================================="
PUTS "INFO and CLOCK Commands Tests Complete"
PUTS "=========================================="
